import streamlit as st
import pandas as pd
from datetime import datetime
from streamlit_gsheets import GSheetsConnection # æ–°å¢é€™å€‹

# 1. å»ºç«‹é€£ç·š
conn = st.connection("gsheets", type=GSheetsConnection)

# 2. è®€å–ç¾æœ‰è³‡æ–™ (ç”¨ä¾†æª¢æŸ¥åé¡)
# æ³¨æ„ï¼šé€™è£¡çš„ spreadsheet ç¶²å€è¦æ›æˆä½ å‰›å‰›è¤‡è£½çš„
df = conn.read(spreadsheet="https://docs.google.com/spreadsheets/d/1nnVGBTNKTEdo_h2Vt2Jo1avIlB70oE8DAaFveXCBCiM/edit?usp=sharing", ttl="0")

# --- (ä¸­é–“çš„é é¢é‚è¼¯ä¿æŒä¸è®Šï¼Œåªéœ€ä¿®æ”¹æœ€å¾Œå­˜æª”çš„éƒ¨åˆ†) ---

# 3. ä¿®æ”¹æœ€å¾Œã€Œå®Œæˆå ±åã€çš„é‚è¼¯
if st.button("å®Œæˆå ±å"):
    if selected_model in available_options:
        # æº–å‚™æ–°è³‡æ–™
        new_row = pd.DataFrame([st.session_state.temp_data])
        # åˆä½µèˆŠè³‡æ–™èˆ‡æ–°è³‡æ–™
        updated_df = pd.concat([df, new_row], ignore_index=True)
        # å¯«å› Google Sheets
        conn.update(spreadsheet="https://docs.google.com/spreadsheets/d/1nnVGBTNKTEdo_h2Vt2Jo1avIlB70oE8DAaFveXCBCiM/edit?usp=sharing", data=updated_df)
        
        st.success("å ±åæˆåŠŸï¼è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯ã€‚")
        st.balloons()

# è¨­å®šå„æ©Ÿç¨®åé¡ä¸Šé™
CAPACITY = {"CUXIE": 50, "CGYNUS": 50, "NMAX": 50, "å¤§å‹é‡æ©Ÿ": 50}

# --- é é¢é‚è¼¯ ---

# ç¬¬ä¸€é ï¼šåŸºæœ¬è³‡æ–™
if st.session_state.page == 1:
    st.title("Step 1: åŸºæœ¬è³‡æ–™")
    name = st.text_input("1. å§“å")
    id_code = st.text_input("2. è­˜åˆ¥ä»£è™Ÿ")
    
    if st.button("ä¸‹ä¸€é "):
        if name and id_code:
            st.session_state.temp_data = {"å§“å": name, "è­˜åˆ¥ä»£è™Ÿ": id_code}
            st.session_state.page = 2
            st.rerun()
        else:
            st.error("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½")

# ç¬¬äºŒé ï¼šåˆ‡çµæ›¸
elif st.session_state.page == 2:
    st.title("Step 2: äº‹å‰åˆ‡çµæ›¸")
    
    # é€™è£¡æ”¾å…¥ä½ çš„åˆ‡çµæ›¸å…·é«”å…§å®¹
    agreement_text = """
    ã€è©¦ä¹˜æ´»å‹•äº‹å‰åˆ‡çµæ›¸ã€‘
    
    æœ¬äººæ–¼æ°‘åœ‹115å¹´1æœˆ30æ—¥ï¼ŒåƒåŠ ç”±å°ç£å±±è‘‰æ©Ÿè»Šå·¥æ¥­è‚¡ä»½æœ‰é™å…¬å¸æ‰€èˆ‰è¾¦ä¹‹ã€å¿˜å¹´æœƒè©¦ä¹˜æ´»å‹•ã€(ä»¥ä¸‹ç°¡ç¨±â€æœ¬æ´»å‹•â€)ï¼Œæ´»å‹•æœŸé–“ï¼Œæœ¬äººå®Œå…¨äº†è§£ä¸¦åŒæ„éµå®ˆä¸»è¾¦å–®ä½æ‰€è¦å®šä¹‹ä¸€åˆ‡å®‰å…¨è¦å‰‡ä»¥åŠä¸‹åˆ—äº‹é …ã€‚
1.	æœ¬äººè‡ªé¡˜åƒåŠ æœ¬æ´»å‹•ï¼Œä¸¦äº†è§£æœ¬æ´»å‹•è‹¥ç„¡åš´è‹›ç®¡æ§å°‡å…·æœ‰ä¸€å®šç¨‹åº¦å±éšªæ€§ï¼Œæœ¬äººæ‡‰å®Œå…¨éµç…§å°ç£å±±è‘‰æ©Ÿè»Šå·¥æ¥­è‚¡ä»½æœ‰é™å…¬å¸(ä»¥ä¸‹ç¨±â€ä¸»è¾¦å–®ä½â€)æ‰€æœ‰ç›¸é—œè¦ç¯„(åŒ…æ‹¬ä½†ä¸é™æ–¼è»Šè¼›ä½¿ç”¨æ–¹å¼ã€é¨ä¹˜æ™‚æ‡‰ç©¿æˆ´ä¹‹å®‰å…¨é˜²è­·å…·ç­‰)ï¼ŒçŸ¥æ‚‰ä¸¦éµå®ˆä¸»è¾¦å–®ä½ä¹‹è¦ç¯„åŠå®‰å…¨è¦ç¯„ï¼Œä¸å¾—æœ‰è¦ç¯„å¤–ä¹‹è¡Œç‚ºã€‚
2.	æœ¬äººå·²è‡ªè¡Œè©•ä¼°ä¸è«–æ˜¯åœ¨å¿ƒæ™ºæˆ–æ˜¯èº«é«”ç‹€æ…‹çš†é©åˆåƒèˆ‡æœ¬æ´»å‹•ï¼Œç¾éšæ®µä¸¦ç„¡é£²ç”¨ä»»ä½•å«é…’ç²¾é£²å“ã€å—œç¡é¡å‹è—¥ç‰©ç­‰ç„¡æ³•å®‰å…¨é§•é§›è»Šè¼›ä¹‹æƒ…äº‹ã€‚
3.	ä»”ç´°è†è½é¨ä¹˜å‰è¨“ç·´ç°¡ä»‹åŠæ³¨æ„äº‹é …ä¹‹å®£é”ï¼Œä¸¦éµå®ˆå·¥ä½œäººå“¡æ‰€æå‡ºä¹‹æŒ‡ç¤ºåŠå»ºè­°ã€‚
4.	åƒèˆ‡æœ¬æ´»å‹•æ™‚ï¼Œå…¨ç¨‹åš´å®ˆä¸»è¾¦å–®ä½å·¥ä½œäººå“¡ä¹‹æŒ‡æ®åŠèª¿åº¦ï¼Œé¿å…é€ æˆå½±éŸ¿é¨ä¹˜ä¹‹ç‹€æ³ç™¼ç”Ÿã€‚
5.	æœ¬æ´»å‹•æœŸé–“ï¼Œæœ¬äººæ‡‰å®Œå…¨éµå®ˆæ‰€æœ‰è¦å®šä¸¦é…æˆ´ç©¿è‘—æ¨™æº–äººèº«éƒ¨å“åŠè­·å…·(å…¨ç½©æˆ–3/4å®‰å…¨å¸½ã€æ©Ÿè»Šå°ˆç”¨æ‰‹å¥—ã€é˜²æ‘”è¡£è¤²æˆ–è­·è†è­·è‚˜ã€ä¸€èˆ¬ä¼‘é–’é‹/çƒé‹ã€é•·è¢–åŠé•·è¤²)ï¼Œåƒèˆ‡æœ¬æ´»å‹•ä¹‹è»Šè¼›ç‚ºå°ç£å±±è‘‰æ©Ÿè»Šæ‰€æœ‰ä¹‹è»Šè¼›ï¼Œæœ¬äººé ˆè€ƒé‡è‡ªèº«ç‹€æ…‹åŠè»Šè¼›æ€§èƒ½ï¼Œæ–¼æœ¬æ´»å‹•é€²è¡Œä¸­å¦‚æœ‰ç™¼ç”Ÿè»Šè¼›æˆ–èº«é«”ä¸Šä¹‹æå‚·å‡ç”±æœ¬äººè‡ªè¡Œè² è²¬ã€‚
6.	åœ¨åƒåŠ æœ¬æ´»å‹•æœŸé–“ï¼Œå€˜è‹¥æœ¬äººæœªéµå®ˆä¸»è¾¦å–®ä½å·¥ä½œäººå“¡ä¹‹æŒ‡ç¤ºæˆ–å ´å…§æ‰€æœ‰è¦å®šå°è‡´ç™¼ç”Ÿä»»ä½•æ„å¤–äº‹æ•…ï¼Œè‡´æœ¬äººæˆ–ä»–äººä¹‹èº«é«”æˆ–è²¡ç”¢ä¸Šå—åˆ°æå®³ï¼Œæœ¬äººåŒæ„è² æ‰€æœ‰ç›¸é—œä¹‹æ°‘ã€åˆ‘äº‹è²¬ä»»ã€‚è‹¥å› æ­¤é€ æˆä¸»è¾¦å–®ä½ä¹‹æå¤±æˆ–æå®³æ™‚ï¼Œäº¦æ‡‰ä¸€ä½µè³ å„Ÿã€‚
7.	é‡è¦ç‰©å“æ‡‰è‡ªè¡Œä¿ç®¡ï¼Œæœ‰ä»»ä½•éºå¤±ã€å¤±ç«Šç­‰ç‹€æ³ï¼Œä¸»è¾¦å–®ä½å°‡ä¸æ‰¿æ“”å…¶ä¿ç®¡åŠè³ å„Ÿè²¬ä»»ã€‚
8.	åœ¨æœ¬æ´»å‹•èˆ‰è¾¦æœŸé–“ï¼Œæœ¬äººæ‰€åƒèˆ‡ä¹‹å„é …æ´»å‹•ï¼Œä¸»è¾¦å–®ä½å¾—å¾äº‹æ”å½±ã€æ‹ç…§ç­‰ç›¸é—œè¡Œç‚ºï¼Œæœ¬äººäº¦åŒæ„ä¸»è¾¦å–®ä½æ“æœ‰æœ¬äººåƒèˆ‡æœ¬æ´»å‹•ä¹‹è‚–åƒåŠè»Šè¼›ç…§ç‰‡ä½¿ç”¨æ¬Šåˆ©ï¼Œä¸¦å¾—ç”¨æ–¼å®£å‚³æˆ–å…¶ä»–å•†æ¥­è¡Œç‚ºã€‚
9.	è‹¥æœ¬äººæœ‰ä»»ä½•é•åä¸Šè¿°è¦å®šã€ä¸éµå®ˆå®‰å…¨è¦å‰‡æˆ–ä¸æœå¾ä¸»è¾¦å–®ä½æŒ‡ç¤ºä¹‹æƒ…äº‹ç™¼ç”Ÿæ™‚ï¼Œå±±è‘‰æœ‰æ¬Šæ‹’çµ•æä¾›æˆ–ç«‹å³çµ‚æ­¢å…¶è©¦é§•é«”é©—æ´»å‹•ã€‚
10.	æœ¬äººæ–¼ç°½ç½²å‰ï¼Œå·²å……åˆ†é–±è®€éä¸¦æ˜ç¢ºäº†è§£æ­¤åˆ‡çµæ›¸ä¹‹å…§å®¹ï¼Œä¸¦å·²å¹´æ»¿18æ­²ï¼Œç‚ºæ°‘æ³•æ‰€è¦å®šä¹‹å®Œå…¨è¡Œç‚ºèƒ½åŠ›äººä¸¦å…·è³‡æ ¼ç°½ç½²æ­¤ä»½åˆ‡çµæ›¸ã€‚

æœ¬äººåœ¨æ­¤åŒæ„ä¸Šè¿°æ‰€æœ‰è²æ˜ä¸¦é¡˜æ„éµå®ˆç›¸é—œæ´»å‹•è¦å‰‡åŠéµå¾ªå±±è‘‰æŒ‡ç¤ºï¼Œç¢ºèªå·²é€æ¢é–±è®€æœ¬åˆ‡çµæ›¸ä¸Šè¿°å„æ¢æ¬¾ï¼Œä¸¦äº†è§£å…¶æ‰€è¡¨é”ä¹‹æ¶µç¾©ï¼Œä¸”ä¿è­‰éµå®ˆæœ¬åˆ‡çµæ›¸ä¹‹å…§å®¹ã€‚

æ­¤è‡´ å°ç£å±±è‘‰æ©Ÿè»Šå·¥æ¥­è‚¡ä»½æœ‰é™å…¬å¸

    
    
    """
    
    # é¡¯ç¤ºåˆ‡çµæ›¸å…§å®¹ï¼ˆç”¨ text_area æˆ– markdownï¼‰
    st.text_area("è«‹é–±è®€ä»¥ä¸‹æ¢æ¬¾ï¼š", value=agreement_text, height=200, disabled=True)
    
    st.markdown("---")
    
    agree = st.radio("æ‚¨æ˜¯å¦åŒæ„ä»¥ä¸Šåˆ‡çµæ›¸å…§å®¹ï¼Ÿ", ["è«‹é¸æ“‡", "åŒæ„", "ä¸åŒæ„"], index=0)
    
    if agree == "åŒæ„":
        st.success("æ‚¨å·²é¸æ“‡åŒæ„ï¼Œè«‹å¡«å¯«ä¸‹æ–¹ç«‹æ›¸äººè³‡è¨Š")
        signer = st.text_input("2. ç«‹æ›¸äºº (è«‹ç°½ç½²å…¨å)")
        personal_id = st.text_input("3. èº«ä»½è­‰å­—è™Ÿ")
        phone = st.text_input("4. é›»è©±")
        
        if st.button("ä¸‹ä¸€é "):
            if signer and personal_id and phone:
                st.session_state.temp_data.update({"ç«‹æ›¸äºº": signer, "èº«ä»½è­‰å­—è™Ÿ": personal_id, "é›»è©±": phone})
                st.session_state.page = 3
                st.rerun()
            else:
                st.error("è«‹å®Œæ•´å¡«å¯«ç«‹æ›¸äººè³‡è¨Š")
                
    elif agree == "ä¸åŒæ„":
        st.warning("è‹¥ä¸åŒæ„åˆ‡çµæ›¸ï¼Œå°‡ç„¡æ³•å®Œæˆå ±åã€‚")
        if st.button("æäº¤ä¸¦çµæŸ"):
            st.write("æ„Ÿè¬æ‚¨çš„å¡«å¯«ã€‚ç”±æ–¼æ‚¨ä¸åŒæ„åˆ‡çµæ›¸ï¼Œå ±åæµç¨‹å·²çµæŸã€‚")
            # é€™è£¡å¯ä»¥é¸æ“‡ä¸å­˜å…¥è³‡æ–™åº«ï¼Œç›´æ¥çµæŸ


# ç¬¬ä¸‰é ï¼šæ©Ÿç¨®é¸æ“‡èˆ‡å“ç‰Œå®£å°
elif st.session_state.page == 3:
    st.title("Step 3: æ©Ÿç¨®èˆ‡å®£å°")
    
    # è¨ˆç®—å‰©é¤˜åé¡
    counts = st.session_state.db['è©¦ä¹˜æ©Ÿç¨®'].value_counts()
    
    def get_label(model):
        remaining = CAPACITY[model] - counts.get(model, 0)
        return f"{model} (å‰©é¤˜åé¡: {remaining})" if remaining > 0 else f"{model} (å·²é¡æ»¿)"

    options = ["CUXIE", "CGYNUS", "NMAX", "å¤§å‹é‡æ©Ÿ"]
    # æª¢æŸ¥å“ªäº›é¸é …å·²é¡æ»¿
    available_options = [opt for opt in options if (CAPACITY[opt] - counts.get(opt, 0)) > 0]
    
    selected_model = st.radio("1. æ¬²è©¦ä¹˜æ©Ÿç¨® (æ¯é …é™50äºº)", options, 
                              index=None,
                              captions=["" if opt in available_options else "å·²é¡æ»¿ä¸å¯é¸" for opt in options])
    
    if selected_model == "å¤§å‹é‡æ©Ÿ":
        st.warning("âš ï¸ é ˆå…·å‚™å¤§å‹é‡å‹æ©Ÿè»Šé§•ç…§ï¼Œè©¦ä¹˜ç•¶å¤©å°‡é€²è¡ŒæŸ¥é©—ã€‚")

    promo = st.radio("2. å“ç‰Œå®£å°", ["åƒåŠ ", "ä¸åƒåŠ "])

    if st.button("å®Œæˆå ±å"):
        if selected_model in available_options:
            st.session_state.temp_data.update({"è©¦ä¹˜æ©Ÿç¨®": selected_model, "å“ç‰Œå®£å°": promo})
            # å­˜å…¥è³‡æ–™åº«
            new_entry = pd.DataFrame([st.session_state.temp_data])
            st.session_state.db = pd.concat([st.session_state.db, new_entry], ignore_index=True)
            st.success("å ±åæˆåŠŸï¼")
            st.balloons()
            if st.button("å›é¦–é "):
                st.session_state.page = 1
                st.rerun()
        else:
            st.error("è©²æ©Ÿç¨®å·²é¡æ»¿ï¼Œè«‹é¸æ“‡å…¶ä»–æ©Ÿç¨®")

# --- å¾Œå°ä¸‹è¼‰å€ (éš±è—å€å¡Š) ---
st.markdown("---")
with st.expander("ğŸ” ç®¡ç†å“¡å¾Œå° (ä¸‹è¼‰æ•¸æ“š)"):
    pw = st.text_input("è¼¸å…¥å¯†ç¢¼æŸ¥çœ‹æ•¸æ“š", type="password")
    if pw == "admin123": # è«‹è‡ªè¡Œæ›´æ”¹å¯†ç¢¼
        st.write("ç›®å‰çš„å ±ååå–®ï¼š")
        st.dataframe(st.session_state.db)
        
        # è½‰æˆ Excel ä¸‹è¼‰
        csv = st.session_state.db.to_csv(index=False).encode('utf-8-sig')
        st.download_button(
            label="é»æ­¤ä¸‹è¼‰ Excel (CSV) æ•¸æ“š",
            data=csv,
            file_name=f"å ±åæ¸…å–®_{datetime.now().strftime('%Y%m%d')}.csv",
            mime="text/csv",

        )

